# Flashnap 要件定義書

## 1. 概要

### 1.1 目的
階層構造で写真を整理し、番号を管理するためのPWAアプリケーション。

### 1.2 背景・課題
- スマホの写真番号（IMG_xxxx）は制御できない
- アプリ内カメラはズームができず、機種依存テストが大変
- 標準カメラを使いつつ、写真番号を管理したい
- リアルタイムで番号がわからないと記録できない

### 1.3 解決策
- 標準カメラを使用（ズーム・操作性を確保）
- PWAで番号を管理
- 撮影時に写真をリネームしてIndexedDBに保存
- カメラロールにも元データが残る（二重保存で安全）

---

## 2. 対象ユーザー

| 項目 | 内容 |
|------|------|
| 利用者 | 写真整理が必要な作業者 |
| 端末 | Androidスマホ |
| 利用環境 | 現場（屋外・屋内） |

---

## 3. 基本フロー

### 3.1 撮影フロー
```
1. PWAで現在の番号を確認（例：本館-1階-廊下-003）
2. 撮影ボタンタップ
3. 標準カメラ起動（ズーム等自由に操作）
4. 撮影（4:3）
5. 自動でPWAに復帰
6. 番号が004にインクリメント＆時刻記録
7. 記録に「本館-1階-廊下-003」と記入
8. 繰り返し
```

### 3.2 エクスポートフロー
```
1. 「エクスポート」ボタンをタップ
2. 保存済み写真一覧を確認
3. 「ZIPダウンロード」をタップ
4. フォルダ分け＆リネーム済みZIPがダウンロード
```

※ マッチング不要。IndexedDBから直接ZIP生成。

---

## 4. 機能要件

### 4.1 調査管理

| 機能 | 説明 |
|------|------|
| 複数調査管理 | 複数の調査を同時に保持・切り替え可能 |
| 調査の作成 | 新規調査を作成 |
| 調査の切り替え | 調査一覧から選択して切り替え |
| 調査の削除 | 調査と関連データを削除 |

### 4.2 階層構造管理

**自由な深さで階層を作成可能**
```
例1：建物のみ
  本館-001

例2：建物 > フロア
  本館-1階-001

例3：建物 > フロア > 部位
  本館-1階-廊下-001

例4：さらに深く
  本館-1階-廊下-東側-001
```

**各階層で番号は独立**
```
本館-1階-廊下：001〜015
本館-1階-トイレ：001〜003
本館-2階-廊下：001〜008
```

**切り替えて戻っても続きから再開**
```
本館-1階-廊下 015まで撮影
  ↓ トイレに移動
本館-1階-トイレ 001〜003
  ↓ 廊下に戻る
本館-1階-廊下 016から再開
```

### 4.3 テンプレート機能

| 機能 | 説明 |
|------|------|
| テンプレート作成 | 階層構造をテンプレートとして保存 |
| テンプレート適用 | 新規調査作成時にテンプレートを適用 |
| テンプレート管理 | テンプレートの編集・削除 |

### 4.4 撮影機能

| 項目 | 仕様 |
|------|------|
| 撮影方式 | `<input type="file" accept="image/*" capture="environment">` |
| カメラ | 標準カメラアプリを使用 |
| 番号表示 | 連番設定に従う（デフォルト: 3桁ゼロ埋め） |
| 記録内容 | ノードID、番号、タイムスタンプ |

### 4.5 連番設定

**デフォルト設定（アプリ全体）**
- 新規調査作成時に適用される

**調査ごとの設定**
- デフォルトを上書き可能

**カスタム項目**
| 項目 | 説明 | 例 |
|------|------|-----|
| 桁数 | 2〜4桁 | 001, 0001 |
| ゼロ埋め | あり/なし | 001 vs 1 |
| 開始番号 | 0 or 1 | 000〜 or 001〜 |
| プレフィックス | 任意テキスト | A-, No. |
| 区切り文字 | `-` `_` など | 本館-001, 本館_001 |

### 4.6 エクスポート機能

**動作**
```
1. エクスポートボタンをタップ
2. IndexedDBに保存された写真一覧を表示
3. ZIPダウンロードをタップ
4. フォルダ分け＆リネーム済みZIPを生成
```

**出力形式**
```
調査名_2025-01-22.zip
├── 本館/
│   ├── 1階/
│   │   ├── 廊下/
│   │   │   ├── 本館-1階-廊下-001.jpg
│   │   │   └── 本館-1階-廊下-002.jpg
│   │   └── トイレ/
│   │       └── 本館-1階-トイレ-001.jpg
│   └── 2階/
│       └── 本館-2階-001.jpg
└── 南棟/
    └── 南棟-001.jpg
```

### 4.7 データ管理

| 機能 | 説明 |
|------|------|
| 保存先 | IndexedDB（ブラウザ内） |
| 写真保存 | 撮影時にリネームしてIndexedDBに保存 |
| 永続性 | ブラウザ閉じても保持 |
| 二重保存 | カメラロール＋IndexedDB（安全性確保） |
| 階層名変更 | 後から修正可能 |

### 4.8 編集・削除機能

| 機能 | 説明 |
|------|------|
| 階層名の編集 | ツリー画面で✏️ボタンから変更 |
| 階層の削除 | ツリー画面で🗑ボタン（子階層・写真も削除） |
| 直前の撮影取り消し | メイン画面の↩ボタン（写真と記録を削除、番号を戻す） |
| 特定の写真削除 | エクスポート画面で個別に削除可能 |

### 4.9 設定・メンテナンス機能

| 機能 | 説明 |
|------|------|
| アプリを更新 | Service Workerとキャッシュを削除して最新版に更新 |
| データをリセット | 写真・階層・記録を全て削除 |
| 連番設定 | デフォルトの連番パターンを設定 |
| ダークモード | ライト/ダーク切り替え |

---

## 5. UI設計

### 5.1 メイン画面（縦持ち）
```
┌──────────────────┐
│  [本館 > 1階 ▼]  │  ← 階層選択
│                  │
│       003        │  ← 次の番号（大きく表示）
│                  │
│   [↩]   [📷]    │  ← 取り消し / 撮影ボタン
├──────────────────┤
│ 履歴（折り返し） │  ← 撮影済み階層一覧
│ [📤 出力] [⚙️]   │
└──────────────────┘
```

### 5.2 メイン画面（横持ち）
```
┌────────────────────────────────────┐
│ [本館>1階 ▼]  003    [↩] [📷]     │
├────────────────────────────────────┤
│ 履歴（横スクロール）  [📤出力][⚙️] │
└────────────────────────────────────┘
```

### 5.3 階層選択モーダル
```
┌────────────────────────────────────┐
│ 📁 階層選択                        │
├────────────────────────────────────┤
│ ▼ 本館（~040）        [+][✏️][🗑] │
│    ▼ 1階（~025）      [+][✏️][🗑] │
│       ● 廊下（~002）  ← 選択中    │
│         トイレ（~003）             │
│      2階（~008）                   │
│   南棟（~010）                     │
├────────────────────────────────────┤
│ [＋ 新規建物]         [閉じる]     │
└────────────────────────────────────┘
```

| ボタン | 機能 |
|--------|------|
| + | 下の階層を追加 |
| ✏️ | 名前を変更 |
| 🗑 | 階層を削除（子階層・写真も削除） |

### 5.4 エクスポートモーダル
```
┌────────────────────────────────┐
│ 📤 エクスポート                │
├────────────────────────────────┤
│ 写真数：25      階層数：4      │
├────────────────────────────────┤
│ 本館-1階-廊下-001.jpg   [削除] │
│ 本館-1階-廊下-002.jpg   [削除] │
│ 本館-1階-トイレ-001.jpg [削除] │
├────────────────────────────────┤
│ [閉じる]      [📥 ZIP出力]     │
└────────────────────────────────┘
```

### 5.5 設定モーダル
```
┌────────────────────────────────┐
│ ⚙️ 設定                        │
├────────────────────────────────┤
│ ダークモード           [切替]  │
├────────────────────────────────┤
│ 連番設定               [編集]  │
│ 桁数、ゼロ埋め、開始番号など   │
├────────────────────────────────┤
│ アプリを更新           [実行]  │
│ 最新版に更新                   │
├────────────────────────────────┤
│ データをリセット       [削除]  │
│ 写真・階層・記録を全削除       │
├────────────────────────────────┤
│           [閉じる]             │
└────────────────────────────────┘
```

### 5.6 調査選択画面
```
┌────────────────────────────────┐
│ 📋 調査一覧                    │
├────────────────────────────────┤
│ ● 本館点検（15枚）  [✏️][🗑]   │
│   南棟点検（8枚）   [✏️][🗑]   │
│   倉庫調査（3枚）   [✏️][🗑]   │
├────────────────────────────────┤
│ [＋ 新規調査]                  │
│ [📁 テンプレート]              │
└────────────────────────────────┘
```

---

## 6. 技術仕様

### 6.1 アーキテクチャ
- 形式：PWA（単一HTMLファイル）
- フレームワーク：なし（Vanilla JS）
- データ保存：IndexedDB
- ZIP生成：JSZip（バンドル、オフライン対応）
- デプロイ：Cloudflare Pages

### 6.2 ファイル構成
```
flashnap/
├── index.html      # メインアプリ（HTML/CSS/JS全部入り）
├── manifest.json   # PWAマニフェスト
├── sw.js           # Service Worker
├── lib/
│   └── jszip.min.js
├── CLAUDE.md
└── REQUIREMENTS.md
```

### 6.3 データ構造

**調査**
```javascript
{
  id: "uuid",
  name: "本館点検",
  numberingConfig: {  // null ならデフォルト設定を使用
    digits: 3,
    zeroPad: true,
    startFrom: 1,
    prefix: "",
    separator: "-"
  },
  createdAt: "2025-01-22T10:00:00Z"
}
```

**ノード（階層）**
```javascript
{
  id: "uuid",
  surveyId: "調査のuuid",
  name: "廊下",
  parentId: "1階のuuid",  // nullならルート（建物）
  currentNumber: 3,
  createdAt: "2025-01-22T10:30:00Z"
}
```

**撮影記録**
```javascript
{
  nodeId: "廊下のuuid",
  number: 1,
  timestamp: "2025-01-22T10:32:15Z",
  photoId: "廊下のuuid-1"
}
```

**写真データ（IndexedDB: photos）**
```javascript
{
  id: "廊下のuuid-1",
  surveyId: "調査のuuid",
  blob: Blob,  // 写真のバイナリデータ
  fileName: "本館-1階-廊下-001.jpg",
  path: ["本館", "1階", "廊下"],
  savedAt: "2025-01-22T10:32:15Z"
}
```

**テンプレート**
```javascript
{
  id: "uuid",
  name: "建物点検テンプレート",
  structure: [
    { name: "本館", children: [
      { name: "1階", children: [
        { name: "廊下" },
        { name: "トイレ" }
      ]},
      { name: "2階" }
    ]}
  ],
  createdAt: "2025-01-22T09:00:00Z"
}
```

**アプリ設定**
```javascript
{
  darkMode: false,
  defaultNumberingConfig: {
    digits: 3,
    zeroPad: true,
    startFrom: 1,
    prefix: "",
    separator: "-"
  }
}
```

---

## 7. 非機能要件

### 7.1 パフォーマンス
- 撮影→番号表示：1秒以内
- ZIP生成：100枚で10秒以内

### 7.2 信頼性
- データはIndexedDBに即時保存
- ブラウザ閉じても消えない
- 「ブラウザのデータ削除」で消える（注意書き必要）

### 7.3 対応環境
- Android Chrome（メイン）
- iOS Safari（動作確認推奨）
- PC Chrome（動作確認用）

### 7.4 オフライン対応
- JSZipをバンドルして完全オフライン動作
- Service Workerでアプリをキャッシュ

---

## 8. 制約事項

### 8.1 技術的制約
- カメラロールへの直接書き込みは不可（ブラウザ制限）
- 写真のリネーム・フォルダ分けはエクスポート時のみ

### 8.2 運用上の注意
- IndexedDBはブラウザデータ削除で消える（カメラロールには残る）
- こまめなエクスポート推奨
- 写真が二重保存されるためストレージ消費が増える

---

## 9. 今後の拡張案（未実装）

- [ ] 写真プレビュー表示
- [ ] クラウド同期
- [ ] 複数端末での番号共有
- [ ] メモの統合
- [ ] PDFレポート出力

---

## 10. 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-01-22 | 初版作成 |
| 2025-01-22 | v2: 編集・削除機能、キャッシュクリア、設定画面を追加 |
| 2026-01-22 | v3: Flashnapとしてリニューアル。複数調査管理、テンプレート、連番カスタマイズ、オフライン対応、ダークモード追加 |
