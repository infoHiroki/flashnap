<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4a90d9">
  <title>Flashnap</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-tertiary: #e8e8e8;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --accent: #4a90d9;
      --accent-hover: #3a7bc8;
      --danger: #e74c3c;
      --danger-hover: #c0392b;
      --success: #27ae60;
      --border: #ddd;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-tertiary: #0f3460;
      --text-primary: #eaeaea;
      --text-secondary: #b0b0b0;
      --border: #2a2a4a;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .header-buttons {
      display: flex;
      gap: 8px;
    }

    /* ãƒœã‚¿ãƒ³å…±é€š */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-icon {
      padding: 8px;
      background: transparent;
      font-size: 1.2rem;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* èª¿æŸ»é¸æŠç”»é¢ */
    .survey-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .survey-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .survey-item:hover {
      background: var(--bg-tertiary);
    }

    .survey-item.active {
      border-color: var(--accent);
      border-width: 2px;
    }

    .survey-info h3 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .survey-info p {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .survey-actions {
      display: flex;
      gap: 4px;
    }

    /* éšå±¤è¡¨ç¤º */
    .hierarchy-section {
      margin-bottom: 24px;
    }

    .breadcrumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .breadcrumb-item {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      background: var(--bg-secondary);
    }

    .breadcrumb-item:hover {
      background: var(--bg-tertiary);
    }

    .breadcrumb-separator {
      color: var(--text-secondary);
    }

    .node-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .node-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .node-item:hover {
      background: var(--bg-tertiary);
    }

    .node-name {
      font-weight: 500;
    }

    .node-count {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .node-actions {
      display: flex;
      gap: 4px;
    }

    /* æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .capture-section {
      text-align: center;
      padding: 24px 0;
    }

    .current-number {
      font-size: 4rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .current-path {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      word-break: break-all;
    }

    .current-count {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .capture-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    /* æ¨ªå‘ãå°‚ç”¨ãƒœã‚¿ãƒ³ã¯ç¸¦å‘ãã§ã¯éè¡¨ç¤º */
    .capture-buttons-landscape {
      display: none;
    }

    .btn-capture {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      font-size: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-undo {
      padding: 12px 24px;
    }

    #fileInput {
      display: none;
    }

    /* æ¨ªæŒã¡å°‚ç”¨ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤ºï¼‰ */
    .landscape-sidebar {
      display: none;
    }

    /* æ¨ªæŒã¡æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    @media (orientation: landscape) and (max-height: 500px) {
      body {
        overflow: hidden;
      }

      .header {
        padding: 6px 16px;
      }

      .main {
        padding: 4px 8px;
        max-width: none;
        overflow: hidden;
      }

      #captureScreen {
        display: grid;
        grid-template-columns: 180px minmax(0, 1fr) 100px;
        grid-template-rows: 1fr;
        gap: 8px;
        height: calc(100dvh - 44px);
        align-items: start;
      }

      /* æ¨ªå‘ãæ™‚ã¯ãƒ‘ãƒ³ããšéè¡¨ç¤ºï¼ˆå·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ä»£æ›¿ï¼‰ */
      .breadcrumbs {
        display: none;
      }

      /* ç¸¦å‘ãç”¨ã®éšå±¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯éè¡¨ç¤º */
      .hierarchy-section {
        display: none;
      }

      /* å·¦: ãƒ„ãƒªãƒ¼ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
      .landscape-sidebar {
        grid-column: 1;
        grid-row: 1;
        display: flex;
        flex-direction: column;
        max-height: 100%;
        overflow-y: auto;
        align-self: start;
        padding-left: 0;
      }

      .landscape-tree {
        flex: 1;
        overflow-y: auto;
      }

      /* ãƒ„ãƒªãƒ¼ã‚¢ã‚¤ãƒ†ãƒ  */
      .tree-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        font-size: 0.8rem;
        cursor: pointer;
        border-left: 3px solid transparent;
        transition: background 0.15s;
      }

      .tree-item:hover {
        background: var(--bg-tertiary);
      }

      .tree-item.selected {
        background: var(--bg-tertiary);
        border-left-color: var(--accent);
      }

      .tree-survey {
        font-weight: 600;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
      }

      .tree-node {
        font-size: 0.75rem;
      }

      .tree-item-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .tree-item-count {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-left: 4px;
        flex-shrink: 0;
      }

      .tree-item-actions {
        display: none;
      }

      .tree-item-actions .btn-icon {
        font-size: 0.75rem;
        padding: 2px 4px;
        opacity: 0.6;
      }

      .tree-item-actions .btn-icon:hover {
        opacity: 1;
      }

      .btn-add-node-landscape {
        margin-top: 8px;
        padding: 6px 8px;
        font-size: 0.8rem;
        width: 100%;
      }

      /* ä¸­å¤®: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ãƒƒãƒ‘ãƒ¼ */
      .center-content {
        grid-column: 2;
        grid-row: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        overflow: hidden;  /* ã¯ã¿å‡ºã—é˜²æ­¢ */
        min-width: 0;      /* flexå­è¦ç´ ã®ç¸®å°è¨±å¯ */
      }

      .capture-section {
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .capture-section .current-number {
        font-size: 4.5rem;
        margin-bottom: 4px;
      }

      .capture-section .current-path {
        display: none;
      }

      .capture-section .current-count {
        display: block;
        font-size: 1.1rem;
        margin-bottom: 4px;
      }

      .capture-section .capture-buttons {
        display: none;
      }

      /* recent-sectionå¾©æ´»ï¼ˆä¸­å¤®ã‚«ãƒ©ãƒ å†…ï¼‰ */
      .recent-section {
        display: block;
        margin-top: 8px;
        width: 100%;
        max-width: 100%;   /* noneã§ã¯ãªã100%ã« */
        overflow: hidden;  /* ã¯ã¿å‡ºã—é˜²æ­¢ */
      }

      .recent-section h3 {
        font-size: 0.8rem;
        margin-bottom: 6px;
        text-align: center;
      }

      .recent-list {
        display: flex;     /* æ˜ç¤ºçš„ã«è¿½åŠ  */
        flex-wrap: nowrap; /* æŠ˜ã‚Šè¿”ã•ãªã„ */
        justify-content: flex-start;
        overflow-x: auto;
        gap: 8px;
      }

      .recent-item {
        width: 50px;
        height: 50px;
      }

      .recent-item-name {
        font-size: 0.55rem;
      }

      /* å³: ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ */
      .capture-buttons-landscape {
        grid-column: 3;
        grid-row: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        position: relative;
      }

      /* å–ã‚Šæ¶ˆã—ãƒœã‚¿ãƒ³ã¯ä¸Šéƒ¨ã«çµ¶å¯¾é…ç½®ï¼ˆã‚«ãƒ¡ãƒ©ä½ç½®ã«å½±éŸ¿ãªã—ï¼‰ */
      .capture-buttons-landscape .btn-undo {
        position: absolute;
        top: 8px;
        font-size: 0.75rem;
        padding: 4px 8px;
      }

      .capture-buttons-landscape .btn-capture {
        width: 80px;
        height: 80px;
        font-size: 2rem;
        border-radius: 50%;
        background: var(--accent);
        color: white;
        border: none;
        cursor: pointer;
      }

      /* æ¨ªæŒã¡æ™‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œ */
      .modal {
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-body {
        padding: 12px;
      }

      .form-group {
        margin-bottom: 8px;
      }

      .form-group input,
      .form-group select {
        padding: 8px;
      }
    }

    /* æœ€è¿‘ã®æ’®å½± */
    .recent-section {
      margin-top: 32px;
    }

    .recent-section h3 {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .recent-list {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
    }

    .recent-item {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .recent-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .recent-item-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 0.65rem;
      padding: 2px 4px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-primary);
      border-radius: 16px;
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      font-size: 1.1rem;
    }

    .modal-body {
      padding: 16px;
    }

    .modal-footer {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding: 16px;
      border-top: 1px solid var(--border);
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ  */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    .form-group label:has(input[type="checkbox"]) {
      display: flex;
      align-items: center;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* è¨­å®š */
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-label {
      font-weight: 500;
    }

    .setting-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    .toggle {
      position: relative;
      width: 48px;
      height: 28px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--bg-tertiary);
      border-radius: 28px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      content: '';
      position: absolute;
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle input:checked + .toggle-slider {
      background: var(--accent);
    }

    .toggle input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå†™çœŸä¸€è¦§ */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      margin-top: 16px;
    }

    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-item-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--danger);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .photo-item-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 0.6rem;
      padding: 4px;
      text-align: center;
    }

    /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ */
    .template-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .template-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }

    /* çµ±è¨ˆ */
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-item {
      text-align: center;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-state {
      text-align: center;
      padding: 48px 16px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mt-16 {
      margin-top: 16px;
    }

    .mb-16 {
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div style="display: flex; align-items: center; gap: 8px;">
      <button class="btn btn-icon hidden" id="btnBack" title="æˆ»ã‚‹">
        <span>â†</span>
      </button>
      <h1 id="headerTitle" style="cursor: pointer;">Flashnap</h1>
    </div>
    <div class="header-buttons">
      <button class="btn btn-icon" id="btnExport" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
        <span>ğŸ“¤</span>
      </button>
      <button class="btn btn-icon" id="btnSettings" title="è¨­å®š">
        <span>âš™ï¸</span>
      </button>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main">
    <!-- èª¿æŸ»é¸æŠç”»é¢ -->
    <section id="surveyScreen">
      <div class="survey-list" id="surveyList"></div>
      <button class="btn btn-primary mt-16" id="btnNewSurvey" style="width: 100%;">
        + æ–°è¦èª¿æŸ»ã‚’ä½œæˆ
      </button>
    </section>

    <!-- æ’®å½±ç”»é¢ -->
    <section id="captureScreen" class="hidden">
      <!-- ãƒ‘ãƒ³ããš -->
      <div class="breadcrumbs" id="breadcrumbs"></div>

      <!-- æ¨ªæŒã¡å°‚ç”¨ãƒ„ãƒªãƒ¼ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
      <div class="landscape-sidebar" id="landscapeSidebar">
        <div class="landscape-tree" id="landscapeTree"></div>
        <button class="btn btn-secondary btn-add-node-landscape" id="btnAddNodeLandscape">
          + éšå±¤è¿½åŠ 
        </button>
      </div>

      <!-- éšå±¤ä¸€è¦§ï¼ˆç¸¦å‘ãç”¨ï¼‰ -->
      <div class="hierarchy-section">
        <div class="node-list" id="nodeList"></div>
        <button class="btn btn-secondary mt-16" id="btnAddNode" style="width: 100%;">
          + éšå±¤ã‚’è¿½åŠ 
        </button>
      </div>

      <!-- ä¸­å¤®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ + æœ€è¿‘ã®æ’®å½±ï¼‰ -->
      <div class="center-content">
        <!-- æ’®å½±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="capture-section">
          <div class="current-number" id="currentNumber">001</div>
          <div class="current-path" id="currentPath">æ’®å½±å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          <div class="current-count" id="currentCount">0æšæ’®å½±æ¸ˆã¿</div>
          <div class="capture-buttons">
            <input type="file" id="fileInput" accept="image/*" capture="environment">
            <button class="btn btn-primary btn-capture" id="btnCapture">
              <span>ğŸ“·</span>
            </button>
            <button class="btn btn-secondary btn-undo hidden" id="btnUndo">
              â†©ï¸ å–ã‚Šæ¶ˆã—
            </button>
          </div>
        </div>

        <!-- æœ€è¿‘ã®æ’®å½± -->
        <div class="recent-section">
          <h3>æœ€è¿‘ã®æ’®å½±</h3>
          <div class="recent-list" id="recentList"></div>
        </div>

      </div>

      <!-- æ¨ªå‘ãå°‚ç”¨ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ -->
      <div class="capture-buttons-landscape">
        <button class="btn btn-secondary btn-undo hidden" id="btnUndoLandscape">
          â†©ï¸ å–ã‚Šæ¶ˆã—
        </button>
        <button class="btn btn-primary btn-capture" id="btnCaptureLandscape">
          <span>ğŸ“·</span>
        </button>
      </div>
    </section>
  </main>

  <!-- èª¿æŸ»ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="surveyModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="surveyModalTitle">æ–°è¦èª¿æŸ»</h2>
        <button class="btn btn-icon" id="btnCloseSurveyModal">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="surveyName">èª¿æŸ»å</label>
          <input type="text" id="surveyName" placeholder="ä¾‹: æœ¬é¤¨ç‚¹æ¤œ">
        </div>
        <div class="form-group">
          <label for="templateSelect">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
          <select id="templateSelect">
            <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—</option>
          </select>
        </div>
        <details class="mt-16">
          <summary style="cursor: pointer; color: var(--text-secondary);">é€£ç•ªè¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</summary>
          <div class="mt-16">
            <div class="form-row">
              <div class="form-group">
                <label for="surveyDigits">æ¡æ•°</label>
                <select id="surveyDigits">
                  <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                  <option value="2">2æ¡</option>
                  <option value="3">3æ¡</option>
                  <option value="4">4æ¡</option>
                </select>
              </div>
              <div class="form-group">
                <label for="surveyStartNum">é–‹å§‹ç•ªå·</label>
                <input type="number" id="surveyStartNum" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ" min="0">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="surveyPrefix">ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹</label>
                <input type="text" id="surveyPrefix" placeholder="ä¾‹: A-">
              </div>
              <div class="form-group">
                <label for="surveySeparator">åŒºåˆ‡ã‚Šæ–‡å­—</label>
                <select id="surveySeparator">
                  <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                  <option value="-">-ï¼ˆãƒã‚¤ãƒ•ãƒ³ï¼‰</option>
                  <option value="_">_ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼‰</option>
                  <option value="">ãªã—</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="surveyZeroPad"> ã‚¼ãƒ­åŸ‹ã‚
              </label>
            </div>
          </div>
        </details>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btnCancelSurvey">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="btnSaveSurvey">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- éšå±¤è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="nodeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="nodeModalTitle">éšå±¤ã‚’è¿½åŠ </h2>
        <button class="btn btn-icon" id="btnCloseNodeModal">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="nodeName">éšå±¤å</label>
          <input type="text" id="nodeName" placeholder="ä¾‹: 1éš">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btnCancelNode">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="btnSaveNode">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="exportModal">
    <div class="modal">
      <div class="modal-header">
        <h2>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
        <button class="btn btn-icon" id="btnCloseExportModal">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="stats" id="exportStats"></div>
        <div class="photo-grid" id="photoGrid"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btnCancelExport">é–‰ã˜ã‚‹</button>
        <button class="btn btn-primary" id="btnDownloadZip">ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2>è¨­å®š</h2>
        <button class="btn btn-icon" id="btnCloseSettingsModal">âœ•</button>
      </div>
      <div class="modal-body">
        <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ -->
        <div class="setting-item">
          <div>
            <div class="setting-label">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="darkModeToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€£ç•ªè¨­å®š -->
        <h3 class="mt-16 mb-16">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€£ç•ªè¨­å®š</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="defaultDigits">æ¡æ•°</label>
            <select id="defaultDigits">
              <option value="2">2æ¡</option>
              <option value="3" selected>3æ¡</option>
              <option value="4">4æ¡</option>
            </select>
          </div>
          <div class="form-group">
            <label for="defaultStartNum">é–‹å§‹ç•ªå·</label>
            <input type="number" id="defaultStartNum" value="1" min="0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="defaultPrefix">ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹</label>
            <input type="text" id="defaultPrefix" placeholder="ãªã—">
          </div>
          <div class="form-group">
            <label for="defaultSeparator">åŒºåˆ‡ã‚Šæ–‡å­—</label>
            <select id="defaultSeparator">
              <option value="-">-ï¼ˆãƒã‚¤ãƒ•ãƒ³ï¼‰</option>
              <option value="_">_ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼‰</option>
              <option value="">ãªã—</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="defaultZeroPad" checked> ã‚¼ãƒ­åŸ‹ã‚
          </label>
        </div>

        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
        <h3 class="mt-16 mb-16">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
        <div class="template-list" id="templateList"></div>
        <button class="btn btn-secondary mt-16" id="btnSaveTemplate" style="width: 100%;">
          ç¾åœ¨ã®éšå±¤ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜
        </button>

        <!-- å±é™ºæ“ä½œ -->
        <h3 class="mt-16 mb-16" style="color: var(--danger);">å±é™ºãªæ“ä½œ</h3>
        <button class="btn btn-secondary mb-16" id="btnUpdateApp" style="width: 100%;">
          ã‚¢ãƒ—ãƒªã‚’æ›´æ–°
        </button>
        <button class="btn btn-danger" id="btnResetData" style="width: 100%;">
          ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        </button>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="btnSaveSettings">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- JSZip -->
  <script src="lib/jszip.min.js"></script>

  <script>
    // ============================================
    // IndexedDB
    // ============================================
    const DB_NAME = 'flashnap';
    const DB_VERSION = 1;
    let db = null;

    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };

        request.onupgradeneeded = (event) => {
          const database = event.target.result;

          // èª¿æŸ»
          if (!database.objectStoreNames.contains('surveys')) {
            const surveys = database.createObjectStore('surveys', { keyPath: 'id' });
            surveys.createIndex('createdAt', 'createdAt');
          }

          // éšå±¤ãƒãƒ¼ãƒ‰
          if (!database.objectStoreNames.contains('nodes')) {
            const nodes = database.createObjectStore('nodes', { keyPath: 'id' });
            nodes.createIndex('surveyId', 'surveyId');
            nodes.createIndex('parentId', 'parentId');
          }

          // æ’®å½±è¨˜éŒ²
          if (!database.objectStoreNames.contains('records')) {
            const records = database.createObjectStore('records', { keyPath: 'id' });
            records.createIndex('surveyId', 'surveyId');
            records.createIndex('nodeId', 'nodeId');
          }

          // å†™çœŸãƒã‚¤ãƒŠãƒª
          if (!database.objectStoreNames.contains('photos')) {
            database.createObjectStore('photos', { keyPath: 'id' });
          }

          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
          if (!database.objectStoreNames.contains('templates')) {
            database.createObjectStore('templates', { keyPath: 'id' });
          }

          // è¨­å®š
          if (!database.objectStoreNames.contains('settings')) {
            database.createObjectStore('settings', { keyPath: 'key' });
          }
        };
      });
    }

    // DBæ±ç”¨æ“ä½œ
    function dbOperation(storeName, mode, operation) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(storeName, mode);
        const store = transaction.objectStore(storeName);
        const request = operation(store);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function dbGetAll(storeName) {
      return dbOperation(storeName, 'readonly', store => store.getAll());
    }

    async function dbGet(storeName, key) {
      return dbOperation(storeName, 'readonly', store => store.get(key));
    }

    async function dbPut(storeName, data) {
      return dbOperation(storeName, 'readwrite', store => store.put(data));
    }

    async function dbDelete(storeName, key) {
      return dbOperation(storeName, 'readwrite', store => store.delete(key));
    }

    async function dbGetByIndex(storeName, indexName, value) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(storeName, 'readonly');
        const store = transaction.objectStore(storeName);
        const index = store.index(indexName);
        const request = index.getAll(value);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function dbClear(storeName) {
      return dbOperation(storeName, 'readwrite', store => store.clear());
    }

    // ============================================
    // çŠ¶æ…‹ç®¡ç†
    // ============================================
    let state = {
      currentSurveyId: null,
      currentNodeId: null,
      lastRecordId: null,
      surveys: [],
      nodes: [],
      records: [],
      templates: [],
      settings: {
        darkMode: false,
        digits: 3,
        startNum: 1,
        zeroPad: true,
        prefix: '',
        separator: '-'
      }
    };

    // ============================================
    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    // ============================================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function buildHierarchyTree(nodes, parentId = null) {
      return nodes
        .filter(n => n.parentId === parentId)
        .sort((a, b) => a.order - b.order)
        .map(node => ({
          ...node,
          children: buildHierarchyTree(nodes, node.id)
        }));
    }

    function buildBreadcrumbs(nodeId, nodesMap) {
      const crumbs = [];
      let current = nodesMap.get(nodeId);
      while (current) {
        crumbs.unshift(current);
        current = current.parentId ? nodesMap.get(current.parentId) : null;
      }
      return crumbs;
    }

    function getHierarchyNames(nodeId, nodesMap) {
      return buildBreadcrumbs(nodeId, nodesMap).map(n => n.name);
    }

    function formatNumber(num, settings) {
      const s = settings || state.settings;
      let result = num.toString();
      if (s.zeroPad) {
        result = result.padStart(s.digits, '0');
      }
      return (s.prefix || '') + result;
    }

    function getNextNumber(nodeId) {
      const records = state.records.filter(r =>
        r.surveyId === state.currentSurveyId && r.nodeId === nodeId
      );
      if (records.length === 0) {
        return getSurveySettings().startNum;
      }
      return Math.max(...records.map(r => r.number)) + 1;
    }

    function getSurveySettings() {
      const survey = state.surveys.find(s => s.id === state.currentSurveyId);
      const defaults = state.settings;
      if (!survey || !survey.settings) return defaults;
      return {
        digits: survey.settings.digits ?? defaults.digits,
        startNum: survey.settings.startNum ?? defaults.startNum,
        zeroPad: survey.settings.zeroPad ?? defaults.zeroPad,
        prefix: survey.settings.prefix ?? defaults.prefix,
        separator: survey.settings.separator ?? defaults.separator
      };
    }

    function getNodesMap() {
      return new Map(state.nodes.map(n => [n.id, n]));
    }

    // ============================================
    // UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ============================================
    const $ = id => document.getElementById(id);

    function showScreen(screenId) {
      $('surveyScreen').classList.toggle('hidden', screenId !== 'survey');
      $('captureScreen').classList.toggle('hidden', screenId !== 'capture');
    }

    function renderSurveyList() {
      const list = $('surveyList');
      if (state.surveys.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <p>èª¿æŸ»ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <p>æ–°è¦èª¿æŸ»ã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
          </div>
        `;
        return;
      }

      list.innerHTML = state.surveys
        .sort((a, b) => b.createdAt - a.createdAt)
        .map(survey => {
          const photoCount = state.records.filter(r => r.surveyId === survey.id).length;
          const nodeCount = state.nodes.filter(n => n.surveyId === survey.id).length;
          return `
            <div class="survey-item ${survey.id === state.currentSurveyId ? 'active' : ''}"
                 data-id="${survey.id}">
              <div class="survey-info">
                <h3>${escapeHtml(survey.name)}</h3>
                <p>å†™çœŸ: ${photoCount}æš / éšå±¤: ${nodeCount}</p>
              </div>
              <div class="survey-actions">
                <button class="btn btn-icon btn-edit-survey" data-id="${survey.id}">âœï¸</button>
                <button class="btn btn-icon btn-delete-survey" data-id="${survey.id}">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        }).join('');

      // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      list.querySelectorAll('.survey-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.closest('.btn')) return;
          selectSurvey(item.dataset.id);
        });
      });

      list.querySelectorAll('.btn-edit-survey').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openSurveyModal(btn.dataset.id);
        });
      });

      list.querySelectorAll('.btn-delete-survey').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteSurvey(btn.dataset.id);
        });
      });
    }

    function renderBreadcrumbs() {
      const container = $('breadcrumbs');
      const nodesMap = getNodesMap();

      // èª¿æŸ»ã«æˆ»ã‚‹ãƒªãƒ³ã‚¯
      const survey = state.surveys.find(s => s.id === state.currentSurveyId);
      let html = `<span class="breadcrumb-item" data-id="survey">${escapeHtml(survey?.name || 'èª¿æŸ»')}</span>`;

      if (state.currentNodeId) {
        const crumbs = buildBreadcrumbs(state.currentNodeId, nodesMap);
        crumbs.forEach((node, i) => {
          html += `<span class="breadcrumb-separator">â€º</span>`;
          html += `<span class="breadcrumb-item" data-id="${node.id}">${escapeHtml(node.name)}</span>`;
        });
      }

      container.innerHTML = html;

      // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      container.querySelectorAll('.breadcrumb-item').forEach(item => {
        item.addEventListener('click', () => {
          if (item.dataset.id === 'survey') {
            // æ’®å½±ç”»é¢ã‚’ç¶­æŒã—ã€ãƒ«ãƒ¼ãƒˆéšå±¤ã§æ’®å½±å¯èƒ½ã«
            state.currentNodeId = null;
            state.lastRecordId = null;
            renderBreadcrumbs();
            renderNodeList();
            renderLandscapeTree();
            renderCaptureSection();
          } else {
            navigateToNode(item.dataset.id);
          }
        });
      });
    }

    function renderNodeList() {
      const container = $('nodeList');
      const surveyNodes = state.nodes.filter(n => n.surveyId === state.currentSurveyId);
      const children = surveyNodes.filter(n => n.parentId === state.currentNodeId);

      if (children.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <p>éšå±¤ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }

      container.innerHTML = children
        .sort((a, b) => a.order - b.order)
        .map(node => {
          const photoCount = state.records.filter(r => r.nodeId === node.id).length;
          const hasChildren = surveyNodes.some(n => n.parentId === node.id);
          return `
            <div class="node-item" data-id="${node.id}">
              <div>
                <span class="node-name">${escapeHtml(node.name)}</span>
                <span class="node-count">${photoCount}æš ${hasChildren ? 'â–¶' : ''}</span>
              </div>
              <div class="node-actions">
                <button class="btn btn-icon btn-edit-node" data-id="${node.id}">âœï¸</button>
                <button class="btn btn-icon btn-delete-node" data-id="${node.id}">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        }).join('');

      // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      container.querySelectorAll('.node-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.closest('.btn')) return;
          navigateToNode(item.dataset.id);
        });
      });

      container.querySelectorAll('.btn-edit-node').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openNodeModal(btn.dataset.id);
        });
      });

      container.querySelectorAll('.btn-delete-node').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteNode(btn.dataset.id);
        });
      });
    }

    // æ¨ªæŒã¡å°‚ç”¨ãƒ„ãƒªãƒ¼è¡¨ç¤ºï¼ˆèª¿æŸ»ä¸€è¦§ + éšå±¤ï¼‰
    function renderLandscapeTree() {
      const container = $('landscapeTree');
      let html = '';

      // èª¿æŸ»ä¸€è¦§
      state.surveys.sort((a, b) => b.createdAt - a.createdAt).forEach(survey => {
        const isCurrentSurvey = survey.id === state.currentSurveyId;
        const isRootSelected = isCurrentSurvey && state.currentNodeId === null;
        const photoCount = state.records.filter(r => r.surveyId === survey.id).length;

        html += `
          <div class="tree-item tree-survey ${isRootSelected ? 'selected' : ''} ${isCurrentSurvey ? 'current' : ''}" data-survey-id="${survey.id}">
            <span class="tree-item-name">ğŸ“‹ ${escapeHtml(survey.name)}</span>
            <span class="tree-item-count">${photoCount}</span>
          </div>
        `;

        // ç¾åœ¨ã®èª¿æŸ»ã®å ´åˆã€éšå±¤ã‚’è¡¨ç¤º
        if (isCurrentSurvey) {
          const surveyNodes = state.nodes.filter(n => n.surveyId === survey.id);

          // ãƒ„ãƒªãƒ¼æ§‹é€ ã‚’å†å¸°çš„ã«æç”»
          function renderNode(node, depth) {
            const photoCount = state.records.filter(r => r.nodeId === node.id).length;
            const isSelected = node.id === state.currentNodeId;
            const indent = depth * 10 + 16;

            let nodeHtml = `
              <div class="tree-item tree-node ${isSelected ? 'selected' : ''}" data-node-id="${node.id}" style="padding-left: ${indent}px;">
                <span class="tree-item-name">ğŸ“ ${escapeHtml(node.name)}</span>
                <span class="tree-item-count">${photoCount}</span>
              </div>
            `;

            const children = surveyNodes.filter(n => n.parentId === node.id).sort((a, b) => a.order - b.order);
            children.forEach(child => {
              nodeHtml += renderNode(child, depth + 1);
            });

            return nodeHtml;
          }

          const rootNodes = surveyNodes.filter(n => n.parentId === null).sort((a, b) => a.order - b.order);
          rootNodes.forEach(node => {
            html += renderNode(node, 1);
          });
        }
      });

      container.innerHTML = html || '<p style="color: var(--text-secondary); font-size: 0.8rem; padding: 8px;">èª¿æŸ»ãŒã‚ã‚Šã¾ã›ã‚“</p>';

      // èª¿æŸ»ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¿ãƒƒãƒ—ã§ãƒ«ãƒ¼ãƒˆéšå±¤ã‚’é¸æŠï¼‰
      container.querySelectorAll('.tree-survey').forEach(item => {
        item.addEventListener('click', () => {
          const surveyId = item.dataset.surveyId;
          if (surveyId !== state.currentSurveyId) {
            selectSurvey(surveyId);
          } else {
            // ç¾åœ¨ã®èª¿æŸ»ã‚’ã‚¿ãƒƒãƒ— â†’ ãƒ«ãƒ¼ãƒˆéšå±¤ã‚’é¸æŠ
            state.currentNodeId = null;
            state.lastRecordId = null;
            renderBreadcrumbs();
            renderNodeList();
            renderLandscapeTree();
            renderCaptureSection();
          }
        });
      });

      // éšå±¤ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      container.querySelectorAll('.tree-node').forEach(item => {
        item.addEventListener('click', () => {
          selectNodeForCapture(item.dataset.nodeId);
        });
      });
    }

    // æ¨ªæŒã¡æ™‚ï¼šéšå±¤ã‚’é¸æŠã—ã¦æ’®å½±å¯¾è±¡ã«è¨­å®š
    function selectNodeForCapture(nodeId) {
      state.currentNodeId = nodeId;
      state.lastRecordId = null;
      renderBreadcrumbs();
      renderNodeList();
      renderLandscapeTree();
      renderCaptureSection();
    }

    function renderCaptureSection() {
      const nodesMap = getNodesMap();
      const settings = getSurveySettings();
      const survey = state.surveys.find(s => s.id === state.currentSurveyId);

      // ç¾åœ¨ã®ç•ªå·
      const nextNum = getNextNumber(state.currentNodeId);
      $('currentNumber').textContent = formatNumber(nextNum, settings);

      // ãƒ‘ã‚¹è¡¨ç¤º
      if (state.currentNodeId) {
        const names = getHierarchyNames(state.currentNodeId, nodesMap);
        $('currentPath').textContent = names.join(settings.separator);
      } else {
        $('currentPath').textContent = survey?.name || 'èª¿æŸ»';
      }

      // ç¾åœ¨ã®éšå±¤ã®æ’®å½±æšæ•°
      const count = state.records.filter(r =>
        r.surveyId === state.currentSurveyId && r.nodeId === state.currentNodeId
      ).length;
      $('currentCount').textContent = `${count}æšæ’®å½±æ¸ˆã¿`;

      // å–ã‚Šæ¶ˆã—ãƒœã‚¿ãƒ³ï¼ˆç¸¦å‘ããƒ»æ¨ªå‘ãä¸¡æ–¹ã‚’åŒæœŸï¼‰
      $('btnUndo').classList.toggle('hidden', !state.lastRecordId);
      $('btnUndoLandscape').classList.toggle('hidden', !state.lastRecordId);
    }

    function renderRecentList() {
      const container = $('recentList');
      const surveyRecords = state.records
        .filter(r => r.surveyId === state.currentSurveyId)
        .sort((a, b) => b.createdAt - a.createdAt)
        .slice(0, 10);

      if (surveyRecords.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">ã¾ã æ’®å½±ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = '';
      surveyRecords.forEach(async record => {
        const photo = await dbGet('photos', record.id);
        if (!photo) return;

        const div = document.createElement('div');
        div.className = 'recent-item';
        div.innerHTML = `
          <img src="${photo.dataUrl}" alt="${record.filename}">
          <div class="recent-item-name">${escapeHtml(record.filename)}</div>
        `;
        container.appendChild(div);
      });
    }

    function renderTemplateList() {
      const container = $('templateList');
      if (state.templates.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = state.templates.map(t => `
        <div class="template-item">
          <span>${escapeHtml(t.name)}</span>
          <button class="btn btn-icon btn-delete-template" data-id="${t.id}">ğŸ—‘ï¸</button>
        </div>
      `).join('');

      container.querySelectorAll('.btn-delete-template').forEach(btn => {
        btn.addEventListener('click', () => deleteTemplate(btn.dataset.id));
      });
    }

    function renderTemplateSelect() {
      const select = $('templateSelect');
      select.innerHTML = '<option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—</option>' +
        state.templates.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================
    // èª¿æŸ»æ“ä½œ
    // ============================================
    async function selectSurvey(surveyId) {
      state.currentSurveyId = surveyId;
      state.currentNodeId = null;
      state.lastRecordId = null;

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã¯Flashnapã®ã¾ã¾ã€æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚‚éè¡¨ç¤ºï¼ˆãƒ‘ãƒ³ããšã§æˆ»ã‚Œã‚‹ï¼‰

      showScreen('capture');
      renderBreadcrumbs();
      renderNodeList();
      renderLandscapeTree();
      renderCaptureSection();
      renderRecentList();
    }

    function openSurveyModal(surveyId = null) {
      const modal = $('surveyModal');
      const isEdit = !!surveyId;

      $('surveyModalTitle').textContent = isEdit ? 'èª¿æŸ»ã‚’ç·¨é›†' : 'æ–°è¦èª¿æŸ»';

      if (isEdit) {
        const survey = state.surveys.find(s => s.id === surveyId);
        $('surveyName').value = survey.name;
        $('templateSelect').value = '';
        if (survey.settings) {
          $('surveyDigits').value = survey.settings.digits || '';
          $('surveyStartNum').value = survey.settings.startNum ?? '';
          $('surveyPrefix').value = survey.settings.prefix || '';
          $('surveySeparator').value = survey.settings.separator ?? '';
          $('surveyZeroPad').checked = survey.settings.zeroPad ?? true;
        }
      } else {
        $('surveyName').value = '';
        $('templateSelect').value = '';
        $('surveyDigits').value = '';
        $('surveyStartNum').value = '';
        $('surveyPrefix').value = '';
        $('surveySeparator').value = '';
        $('surveyZeroPad').checked = true;
      }

      modal.dataset.editId = surveyId || '';
      renderTemplateSelect();
      modal.classList.add('active');
    }

    async function saveSurvey() {
      const modal = $('surveyModal');
      const editId = modal.dataset.editId;
      const name = $('surveyName').value.trim();

      if (!name) {
        alert('èª¿æŸ»åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const settings = {};
      if ($('surveyDigits').value) settings.digits = parseInt($('surveyDigits').value);
      if ($('surveyStartNum').value !== '') settings.startNum = parseInt($('surveyStartNum').value);
      if ($('surveyPrefix').value) settings.prefix = $('surveyPrefix').value;
      if ($('surveySeparator').value !== '') settings.separator = $('surveySeparator').value;
      settings.zeroPad = $('surveyZeroPad').checked;

      if (editId) {
        // ç·¨é›†
        const survey = state.surveys.find(s => s.id === editId);
        survey.name = name;
        survey.settings = Object.keys(settings).length > 0 ? settings : null;
        await dbPut('surveys', survey);
      } else {
        // æ–°è¦ä½œæˆ
        const survey = {
          id: generateId(),
          name,
          settings: Object.keys(settings).length > 0 ? settings : null,
          createdAt: Date.now()
        };
        await dbPut('surveys', survey);
        state.surveys.push(survey);

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨
        const templateId = $('templateSelect').value;
        if (templateId) {
          await applyTemplate(survey.id, templateId);
        }
      }

      modal.classList.remove('active');
      renderSurveyList();
    }

    async function deleteSurvey(surveyId) {
      if (!confirm('ã“ã®èª¿æŸ»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹å…¨ã¦ã®å†™çœŸã¨éšå±¤ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;

      // é–¢é€£ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
      const records = state.records.filter(r => r.surveyId === surveyId);
      for (const record of records) {
        await dbDelete('photos', record.id);
        await dbDelete('records', record.id);
      }
      state.records = state.records.filter(r => r.surveyId !== surveyId);

      const nodes = state.nodes.filter(n => n.surveyId === surveyId);
      for (const node of nodes) {
        await dbDelete('nodes', node.id);
      }
      state.nodes = state.nodes.filter(n => n.surveyId !== surveyId);

      await dbDelete('surveys', surveyId);
      state.surveys = state.surveys.filter(s => s.id !== surveyId);

      if (state.currentSurveyId === surveyId) {
        state.currentSurveyId = null;
        state.currentNodeId = null;
      }

      renderSurveyList();
    }

    // ============================================
    // éšå±¤æ“ä½œ
    // ============================================
    function navigateToNode(nodeId) {
      state.currentNodeId = nodeId;
      state.lastRecordId = null;
      renderBreadcrumbs();
      renderNodeList();
      renderLandscapeTree();
      renderCaptureSection();
    }

    function openNodeModal(nodeId = null) {
      const modal = $('nodeModal');
      const isEdit = !!nodeId;

      $('nodeModalTitle').textContent = isEdit ? 'éšå±¤ã‚’ç·¨é›†' : 'éšå±¤ã‚’è¿½åŠ ';

      if (isEdit) {
        const node = state.nodes.find(n => n.id === nodeId);
        $('nodeName').value = node.name;
      } else {
        $('nodeName').value = '';
      }

      modal.dataset.editId = nodeId || '';
      modal.classList.add('active');
    }

    async function saveNode() {
      const modal = $('nodeModal');
      const editId = modal.dataset.editId;
      const name = $('nodeName').value.trim();

      if (!name) {
        alert('éšå±¤åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (editId) {
        // ç·¨é›†
        const node = state.nodes.find(n => n.id === editId);
        node.name = name;
        await dbPut('nodes', node);
      } else {
        // æ–°è¦ä½œæˆ
        const siblings = state.nodes.filter(n =>
          n.surveyId === state.currentSurveyId && n.parentId === state.currentNodeId
        );
        const node = {
          id: generateId(),
          surveyId: state.currentSurveyId,
          parentId: state.currentNodeId,
          name,
          order: siblings.length,
          createdAt: Date.now()
        };
        await dbPut('nodes', node);
        state.nodes.push(node);
      }

      modal.classList.remove('active');
      renderNodeList();
      renderLandscapeTree();
    }

    async function deleteNode(nodeId) {
      if (!confirm('ã“ã®éšå±¤ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå­éšå±¤ã¨å†™çœŸã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;

      // å†å¸°çš„ã«å­ãƒãƒ¼ãƒ‰ã‚’å–å¾—
      const getDescendants = (id) => {
        const children = state.nodes.filter(n => n.parentId === id);
        return [id, ...children.flatMap(c => getDescendants(c.id))];
      };

      const nodeIds = getDescendants(nodeId);

      // é–¢é€£å†™çœŸå‰Šé™¤
      for (const nid of nodeIds) {
        const records = state.records.filter(r => r.nodeId === nid);
        for (const record of records) {
          await dbDelete('photos', record.id);
          await dbDelete('records', record.id);
        }
        state.records = state.records.filter(r => r.nodeId !== nid);
      }

      // ãƒãƒ¼ãƒ‰å‰Šé™¤
      for (const nid of nodeIds) {
        await dbDelete('nodes', nid);
      }
      state.nodes = state.nodes.filter(n => !nodeIds.includes(n.id));

      if (state.currentNodeId === nodeId) {
        const node = state.nodes.find(n => n.id === nodeId);
        state.currentNodeId = node?.parentId || null;
      }

      renderNodeList();
      renderLandscapeTree();
      renderCaptureSection();
    }

    // ============================================
    // æ’®å½±æ©Ÿèƒ½
    // ============================================

    // 4:3ã‚¯ãƒ­ãƒƒãƒ—å‡¦ç†
    function cropTo4by3(dataUrl) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const srcW = img.width;
          const srcH = img.height;
          const targetRatio = 4 / 3;
          const srcRatio = srcW / srcH;
          console.log(`å…ƒç”»åƒ: ${srcW}x${srcH} (æ¯”ç‡: ${srcRatio.toFixed(3)}, 4:3=${targetRatio.toFixed(3)})`);

          let cropW, cropH, cropX, cropY;

          if (srcRatio > targetRatio) {
            // æ¨ªé•·ã™ãã‚‹ â†’ å·¦å³ã‚’ã‚«ãƒƒãƒˆ
            cropH = srcH;
            cropW = Math.round(srcH * targetRatio);
            cropX = Math.round((srcW - cropW) / 2);
            cropY = 0;
          } else {
            // ç¸¦é•·ã™ãã‚‹ â†’ ä¸Šä¸‹ã‚’ã‚«ãƒƒãƒˆ
            cropW = srcW;
            cropH = Math.round(srcW / targetRatio);
            cropX = 0;
            cropY = Math.round((srcH - cropH) / 2);
          }

          console.log(`ã‚¯ãƒ­ãƒƒãƒ—å¾Œ: ${cropW}x${cropH} (åˆ‡ã‚Šå–ã‚Šä½ç½®: x=${cropX}, y=${cropY})`);

          const canvas = document.createElement('canvas');
          canvas.width = cropW;
          canvas.height = cropH;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

          resolve(canvas.toDataURL('image/jpeg', 0.92));
        };
        img.src = dataUrl;
      });
    }

    async function handleCapture(file) {
      const nodesMap = getNodesMap();
      const settings = getSurveySettings();
      const survey = state.surveys.find(s => s.id === state.currentSurveyId);
      const nextNum = getNextNumber(state.currentNodeId);

      // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
      let filename;
      if (state.currentNodeId) {
        const names = getHierarchyNames(state.currentNodeId, nodesMap);
        filename = names.join(settings.separator) + settings.separator + formatNumber(nextNum, settings) + '.jpg';
      } else {
        filename = (survey?.name || 'èª¿æŸ»') + settings.separator + formatNumber(nextNum, settings) + '.jpg';
      }

      // ç”»åƒã‚’DataURLã«å¤‰æ›
      const rawDataUrl = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
      });

      // 4:3ã«ã‚¯ãƒ­ãƒƒãƒ—
      const dataUrl = await cropTo4by3(rawDataUrl);

      // è¨˜éŒ²ä¿å­˜
      const record = {
        id: generateId(),
        surveyId: state.currentSurveyId,
        nodeId: state.currentNodeId,
        number: nextNum,
        filename,
        createdAt: Date.now()
      };
      await dbPut('records', record);
      state.records.push(record);

      // å†™çœŸä¿å­˜
      await dbPut('photos', { id: record.id, dataUrl });

      // Downloadsãƒ•ã‚©ãƒ«ãƒ€ã«ã‚‚ä¿å­˜
      downloadPhoto(dataUrl, filename);

      state.lastRecordId = record.id;
      renderLandscapeTree();
      renderCaptureSection();
      renderRecentList();
    }

    // Downloadsãƒ•ã‚©ãƒ«ãƒ€ã«ã‚‚ä¿å­˜
    function downloadPhoto(dataUrl, filename) {
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      a.click();
    }

    async function undoCapture() {
      if (!state.lastRecordId) return;
      if (!confirm('ç›´å‰ã®æ’®å½±ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) return;

      const recordId = state.lastRecordId;
      await dbDelete('photos', recordId);
      await dbDelete('records', recordId);
      state.records = state.records.filter(r => r.id !== recordId);
      state.lastRecordId = null;

      renderLandscapeTree();
      renderCaptureSection();
      renderRecentList();
    }

    // ============================================
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    // ============================================
    async function openExportModal() {
      const modal = $('exportModal');
      const records = state.records.filter(r => r.surveyId === state.currentSurveyId);
      const nodes = state.nodes.filter(n => n.surveyId === state.currentSurveyId);

      // çµ±è¨ˆ
      $('exportStats').innerHTML = `
        <div class="stat-item">
          <div class="stat-value">${records.length}</div>
          <div class="stat-label">å†™çœŸ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${nodes.length}</div>
          <div class="stat-label">éšå±¤</div>
        </div>
      `;

      // å†™çœŸä¸€è¦§
      const grid = $('photoGrid');
      grid.innerHTML = '';

      for (const record of records) {
        const photo = await dbGet('photos', record.id);
        if (!photo) continue;

        const div = document.createElement('div');
        div.className = 'photo-item';
        div.innerHTML = `
          <img src="${photo.dataUrl}" alt="${record.filename}">
          <button class="photo-item-delete" data-id="${record.id}">âœ•</button>
          <div class="photo-item-name">${escapeHtml(record.filename)}</div>
        `;
        grid.appendChild(div);
      }

      grid.querySelectorAll('.photo-item-delete').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
          await deletePhoto(btn.dataset.id);
          openExportModal(); // å†æç”»
        });
      });

      modal.classList.add('active');
    }

    async function deletePhoto(recordId) {
      await dbDelete('photos', recordId);
      await dbDelete('records', recordId);
      state.records = state.records.filter(r => r.id !== recordId);
      if (state.lastRecordId === recordId) {
        state.lastRecordId = null;
      }
      renderCaptureSection();
      renderRecentList();
    }

    async function downloadZip() {
      const survey = state.surveys.find(s => s.id === state.currentSurveyId);
      const records = state.records.filter(r => r.surveyId === state.currentSurveyId);

      if (records.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const zip = new JSZip();
      const nodesMap = getNodesMap();
      const settings = getSurveySettings();

      for (const record of records) {
        const photo = await dbGet('photos', record.id);
        if (!photo) continue;

        // ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ç”Ÿæˆ
        const names = getHierarchyNames(record.nodeId, nodesMap);
        const folderPath = names.join('/');
        const base64 = photo.dataUrl.split(',')[1];

        zip.file(`${folderPath}/${record.filename}`, base64, { base64: true });
      }

      const content = await zip.generateAsync({ type: 'blob' });
      const date = new Date().toISOString().split('T')[0];
      const filename = `${survey.name}_${date}.zip`;

      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);

      $('exportModal').classList.remove('active');
    }

    // ============================================
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    // ============================================
    async function saveAsTemplate() {
      if (!state.currentSurveyId) {
        alert('èª¿æŸ»ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const surveyNodes = state.nodes.filter(n => n.surveyId === state.currentSurveyId);
      if (surveyNodes.length === 0) {
        alert('ä¿å­˜ã™ã‚‹éšå±¤ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const name = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (!name) return;

      // ãƒãƒ¼ãƒ‰æ§‹é€ ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆIDã‚’é™¤ãï¼‰
      const nodesCopy = surveyNodes.map(n => ({
        name: n.name,
        parentId: n.parentId,
        order: n.order
      }));

      // parentIdã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¤‰æ›
      const idToIndex = new Map(surveyNodes.map((n, i) => [n.id, i]));
      nodesCopy.forEach(n => {
        n.parentIndex = n.parentId ? idToIndex.get(n.parentId) : null;
        delete n.parentId;
      });

      const template = {
        id: generateId(),
        name,
        nodes: nodesCopy,
        createdAt: Date.now()
      };

      await dbPut('templates', template);
      state.templates.push(template);
      renderTemplateList();
      renderTemplateSelect();
    }

    async function applyTemplate(surveyId, templateId) {
      const template = state.templates.find(t => t.id === templateId);
      if (!template) return;

      const newIds = [];

      for (const nodeDef of template.nodes) {
        const node = {
          id: generateId(),
          surveyId,
          parentId: nodeDef.parentIndex !== null ? newIds[nodeDef.parentIndex] : null,
          name: nodeDef.name,
          order: nodeDef.order,
          createdAt: Date.now()
        };
        await dbPut('nodes', node);
        state.nodes.push(node);
        newIds.push(node.id);
      }
    }

    async function deleteTemplate(templateId) {
      if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      await dbDelete('templates', templateId);
      state.templates = state.templates.filter(t => t.id !== templateId);
      renderTemplateList();
      renderTemplateSelect();
    }

    // ============================================
    // è¨­å®š
    // ============================================
    function openSettingsModal() {
      const modal = $('settingsModal');
      const s = state.settings;

      $('darkModeToggle').checked = s.darkMode;
      $('defaultDigits').value = s.digits;
      $('defaultStartNum').value = s.startNum;
      $('defaultPrefix').value = s.prefix;
      $('defaultSeparator').value = s.separator;
      $('defaultZeroPad').checked = s.zeroPad;

      renderTemplateList();
      modal.classList.add('active');
    }

    async function saveSettings() {
      state.settings = {
        darkMode: $('darkModeToggle').checked,
        digits: parseInt($('defaultDigits').value),
        startNum: parseInt($('defaultStartNum').value),
        prefix: $('defaultPrefix').value,
        separator: $('defaultSeparator').value,
        zeroPad: $('defaultZeroPad').checked
      };

      await dbPut('settings', { key: 'app', ...state.settings });
      applyTheme();
      $('settingsModal').classList.remove('active');

      if (state.currentSurveyId) {
        renderCaptureSection();
      }
    }

    function applyTheme() {
      document.documentElement.dataset.theme = state.settings.darkMode ? 'dark' : 'light';
    }

    async function updateApp() {
      if (!confirm('ã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) return;

      if ('serviceWorker' in navigator) {
        const registration = await navigator.serviceWorker.getRegistration();
        if (registration) {
          await registration.unregister();
        }
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));
      }

      location.reload();
    }

    async function resetData() {
      if (!confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
      if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      await dbClear('surveys');
      await dbClear('nodes');
      await dbClear('records');
      await dbClear('photos');
      await dbClear('templates');

      state.surveys = [];
      state.nodes = [];
      state.records = [];
      state.templates = [];
      state.currentSurveyId = null;
      state.currentNodeId = null;
      state.lastRecordId = null;

      $('settingsModal').classList.remove('active');
      showScreen('survey');
      renderSurveyList();
    }

    // ============================================
    // åˆæœŸåŒ–
    // ============================================
    async function init() {
      await initDB();

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      state.surveys = await dbGetAll('surveys');
      state.nodes = await dbGetAll('nodes');
      state.records = await dbGetAll('records');
      state.templates = await dbGetAll('templates');

      const savedSettings = await dbGet('settings', 'app');
      if (savedSettings) {
        state.settings = { ...state.settings, ...savedSettings };
      }

      applyTheme();
      showScreen('survey');
      renderSurveyList();

      // Service Workerç™»éŒ²
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    }

    function setupEventListeners() {
      // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³
      $('btnBack').addEventListener('click', () => {
        state.currentSurveyId = null;
        state.currentNodeId = null;
        $('headerTitle').textContent = 'Flashnap';
        $('btnBack').classList.add('hidden');
        showScreen('survey');
        renderSurveyList();
      });
      $('btnExport').addEventListener('click', () => {
        if (!state.currentSurveyId) {
          alert('èª¿æŸ»ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        openExportModal();
      });
      $('btnSettings').addEventListener('click', openSettingsModal);
      $('headerTitle').addEventListener('click', () => {
        state.currentSurveyId = null;
        state.currentNodeId = null;
        showScreen('survey');
        renderSurveyList();
      });

      // èª¿æŸ»ãƒ¢ãƒ¼ãƒ€ãƒ«
      $('btnNewSurvey').addEventListener('click', () => openSurveyModal());
      $('btnCloseSurveyModal').addEventListener('click', () => $('surveyModal').classList.remove('active'));
      $('btnCancelSurvey').addEventListener('click', () => $('surveyModal').classList.remove('active'));
      $('btnSaveSurvey').addEventListener('click', saveSurvey);

      // éšå±¤ãƒ¢ãƒ¼ãƒ€ãƒ«
      $('btnAddNode').addEventListener('click', () => openNodeModal());
      $('btnAddNodeLandscape').addEventListener('click', () => openNodeModal());
      $('btnCloseNodeModal').addEventListener('click', () => $('nodeModal').classList.remove('active'));
      $('btnCancelNode').addEventListener('click', () => $('nodeModal').classList.remove('active'));
      $('btnSaveNode').addEventListener('click', saveNode);

      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
      $('btnCloseExportModal').addEventListener('click', () => $('exportModal').classList.remove('active'));
      $('btnCancelExport').addEventListener('click', () => $('exportModal').classList.remove('active'));
      $('btnDownloadZip').addEventListener('click', downloadZip);

      // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
      $('btnCloseSettingsModal').addEventListener('click', () => $('settingsModal').classList.remove('active'));
      $('btnSaveSettings').addEventListener('click', saveSettings);
      $('btnSaveTemplate').addEventListener('click', saveAsTemplate);
      $('btnUpdateApp').addEventListener('click', updateApp);
      $('btnResetData').addEventListener('click', resetData);

      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å³æ™‚åæ˜ 
      $('darkModeToggle').addEventListener('change', () => {
        state.settings.darkMode = $('darkModeToggle').checked;
        applyTheme();
      });

      // æ’®å½±
      $('btnCapture').addEventListener('click', () => $('fileInput').click());
      $('btnCaptureLandscape').addEventListener('click', () => $('fileInput').click());
      $('fileInput').addEventListener('change', (e) => {
        if (e.target.files[0]) {
          handleCapture(e.target.files[0]);
          e.target.value = '';
        }
      });
      $('btnUndo').addEventListener('click', undoCapture);
      $('btnUndoLandscape').addEventListener('click', undoCapture);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('active');
          }
        });
      });
    }

    // èµ·å‹•
    init();
  </script>
</body>
</html>
